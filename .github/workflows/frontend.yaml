name: Client CI/CD

on:
  push:
    branches: [main, testing, 'feature/**']
  pull_request:
    branches: [main, testing]

env:
  NODE_VERSION: '22'
  WORKING_DIR: 'client/vite-project'

jobs:
  # ============================================
  # JOB 1: Test Frontend
  # ============================================
  test:
    name: Test Frontend
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./client/vite-project
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm ci

      # - name: Run Tests with Coverage
      #   run: npm test -- --coverage --watchAll=false
      #   env:
      #     CI: true
      #     NODE_ENV: test
      #   continue-on-error: false

      # - name: Upload Coverage
      #   uses: codecov/codecov-action@v3
      #   if: always()
      #   with:
      #     files: ./client/vite-project/coverage/lcov.info
      #     flags: frontend
      #   continue-on-error: true

  # ============================================
  # JOB 2: Build Verification
  # ============================================
  build:
   name: Build Verification
   runs-on: ubuntu-latest
   needs: test

   steps:
    - name: Checkout Code
      uses: actions/checkout@v5

    - name: Clone Client Repo (Actual Frontend Code)
      run: |
        rm -rf client    # Remove placeholder if exists
        git clone https://github.com/Siddharth2k14/online-exam-portal-client.git client
        ls -la client

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Debug - List All Files
      run: |
        echo "=== CURRENT DIRECTORY ==="
        pwd
        ls -la
        echo ""
        echo "=== CLIENT DIRECTORY ==="
        ls -la client || echo "No client folder"
        echo ""
        echo "=== VITE PROJECT DIRECTORY ==="
        ls -la client/vite-project || echo "No vite-project folder"

    - name: Debug - Confirm package.json and scripts
      working-directory: client/vite-project
      run: |
        echo "PWD: $(pwd)"
        echo "FILES HERE:"
        ls -la
        echo "PACKAGE.JSON CONTENT:"
        cat package.json || echo "package.json NOT FOUND!"
        echo "NPM SCRIPTS:"
        npm run || echo "npm run failed"

    - name: Install Dependencies
      working-directory: client/vite-project
      run: npm ci

    - name: Build Application
      working-directory: client/vite-project
      run: npm run build
      env:
        CI: true

    - name: Check Build Size
      working-directory: client/vite-project
      run: |
        echo "üì¶ Build Size:"
        du -sh dist || echo "dist folder not found"
        size=$(du -sm dist | cut -f1 || echo 0)
        echo "Total: ${size}MB"

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: vite-build-${{ github.sha }}
        path: client/vite-project/dist/
        retention-days: 7



  # ============================================
  # JOB 3: Security Audit
  # ============================================
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: client/vite-project

    steps:
      - name: Checkout Code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm ci

      - name: Run npm Audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Dependency Review (PRs only)
        uses: actions/dependency-review-action@v4
        if: github.event_name == 'pull_request'
        continue-on-error: true

  # ============================================
  # JOB 4: Deploy to Staging
  # ============================================
  deploy-staging:
    name: üöÄ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/testing' && github.event_name == 'push'

    environment:
      name: staging
      url: https://online-exam-portal-client-testing.vercel.app/

    defaults:
      run:
        working-directory: client/vite-project

    steps:
      - name: Checkout Code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm ci

      - name: Build for Staging
        run: npm run build
        env:
          CI: true
          VITE_API_URL: ${{ secrets.STAGING_API_URL }}
          VITE_APP_ENV: staging
      
      - name: Deploy to Vercel (Staging)
        uses: amondnet/vercel-action@v25
        id: vercel-staging
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: client/vite-project

      - name: Wait for Deployment
        run: sleep 10

      - name: Smoke Test Staging
        run: |
          echo "üß™ Testing staging deployment..."
          response=$(curl -s -o /dev/null -w "%{http_code}" https://online-exam-portal-client-testing.vercel.app/)
          if [ $response -ne 200 ]; then
            echo "‚ùå Staging returned HTTP $response"
            exit 1
          fi
          echo "‚úÖ Staging deployment successful!"

      - name: Comment Deployment URL
        uses: actions/github-script@v6
        if: github.event_name == 'pull_request'
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üöÄ **Staging Deployed**\n\n‚úÖ Preview: ${{ steps.vercel-staging.outputs.preview-url }}'
            })

  # ============================================
  # JOB 5: Deploy to Production
  # ============================================
  deploy-production:
    name: üéØ Deploy to Production
    runs-on: ubuntu-latest
    needs: [test, build, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    environment:
      name: production
      url: https://online-exam-portal-client.vercel.app

    defaults:
      run:
        working-directory: client/vite-project
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v5
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Dependencies
        run: npm ci
      
      - name: Build for Production
        run: npm run build
        env:
          CI: true
          VITE_API_URL: ${{ secrets.PROD_API_URL }}
          VITE_APP_ENV: production
      
      - name: Deploy to Vercel Production
        uses: amondnet/vercel-action@v25
        id: vercel-production
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: client/vite-project
      
      - name: Wait for Production Deployment
        run: sleep 15
      
      - name: Production Health Checks
        run: |
          echo "üè• Running production health checks..."
          
          # Test homepage
          echo "Testing homepage..."
          curl -f https://online-exam-portal-client.vercel.app/ || exit 1
          
          echo "Testing login page..."
          curl -f https://online-exam-portal-client.vercel.app/login || echo "Login page check skipped"
          
          echo "‚úÖ Production deployment verified!"
      
      - name: Create Deployment Tag
        working-directory: ./
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          tag="prod-$(date +%Y%m%d-%H%M%S)"
          git tag -a $tag -m "Production deployment: ${{ github.sha }}"
          git push origin $tag || echo "Tag already exists"
      
      - name: Notify Success
        if: success()
        run: |
          echo "::notice title=Production Deployed::üéâ Production successfully deployed!"
          echo "::notice title=Production URL::https://online-exam-portal-client.vercel.app"
          echo "::notice title=Commit::${{ github.sha }}"
          echo "::notice title=Deployed by::${{ github.actor }}"
      
      - name: Notify Failure
        if: failure()
        run: |
          echo "::error title=Deployment Failed::‚ùå Production deployment failed!"
          echo "::error title=Check Logs::${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

  # ============================================
  # JOB 6: Preview for Feature Branches
  # ============================================
  preview-feature:
    name: üì∏ Preview Deployment
    runs-on: ubuntu-latest
    needs: [test, build]
    if: startsWith(github.ref, 'refs/heads/feature/') && github.event_name == 'push'

    defaults:
      run:
        working-directory: client/vite-project

    steps:
      - name: Checkout Code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm ci

      - name: Build Feature Preview
        run: npm run build
        env:
          CI: true
          VITE_API_URL: ${{ secrets.STAGING_API_URL }}
          VITE_APP_ENV: preview
      
      - name: Deploy Preview to Vercel
        uses: amondnet/vercel-action@v25
        id: vercel-preview
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          github-comment: false
          working-directory: client/vite-project

      - name: Comment Preview URL
        uses: actions/github-script@v6
        if: github.event_name == 'pull_request'
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üé® **Feature Preview Deployed**\n\n‚ú® Preview URL: ${{ steps.vercel-preview.outputs.preview-url }}\n\n_This preview will be deleted when the PR is closed._'
            })
      
      - name: Print Preview URL
        run: |
          echo "::notice title=Feature Preview::Preview available at ${{ steps.vercel-preview.outputs.preview-url }}"