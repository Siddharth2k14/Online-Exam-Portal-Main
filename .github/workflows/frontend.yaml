name: Full Stack CI Orchestrator

on:
  workflow_dispatch: # Optionally: manual start
  repository_dispatch:
    types: [client_updated, server_updated]

jobs:
  check-client:
    runs-on: ubuntu-latest
    steps:
      - name: Check latest Client CI status
        run: |
            echo "üîç Fetching latest workflow runs for client repo..."
            RESPONSE=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.MAIN_REPO_TOKEN }}" \
            https://api.github.com/repos/Siddharth2k14/online-exam-portal-client/actions/runs)

            echo "$RESPONSE" | head -n 20  # Show first lines of response for debugging

            STATUS=$(echo "$RESPONSE" | jq -r '.workflow_runs[0].conclusion')
            EVENT=$(echo "$RESPONSE" | jq -r '.workflow_runs[0].event')
            STATUS_TEXT=${STATUS:-"null (no completed workflow found)"}

            echo "‚úÖ Latest client workflow event: $EVENT"
            echo "‚úÖ Latest client workflow status: $STATUS_TEXT"

            if [ "$STATUS" != "success" ]; then
            echo "‚ùå Client CI is not successful (status = $STATUS_TEXT)"
            exit 1
            fi


  check-server:
    needs: check-client
    runs-on: ubuntu-latest
    steps:
      - name: Check latest Server CI status
        run: |
          STATUS=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.MAIN_REPO_TOKEN }}" \
            https://api.github.com/repos/Siddharth2k14/online-exam-portal-server/actions/runs \
            | jq -r '.workflow_runs[0].conclusion')

          echo "Server Status: $STATUS"
          if [ "$STATUS" != "success" ]; then
            echo "‚ùå Server CI failed!"
            exit 1
          fi

  success-notification:
    needs: [check-client, check-server]
    runs-on: ubuntu-latest
    steps:
      - name: Notify success
        run: echo "‚úÖ Both Client & Server CI/CD passed! Ready to deploy or merge."
